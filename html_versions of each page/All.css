import React, { useState, useEffect, useRef } from 'react';

export default function GraphBFS() {
  const graph = {
    A: ["B", "C"],
    B: ["D", "E"],
    C: ["F"],
    D: [],
    E: ["F"],
    F: []
  };

  const codeLines = [
    'void bfs(int start) {',
    '    queue<int> q;',
    '    visited[start] = true;',
    '    q.push(start);',
    '    while (!q.empty()) {',
    '        int u = q.front(); q.pop();',
    '        for (int v : adj[u]) {',
    '            if (!visited[v]) {',
    '                visited[v] = true;',
    '                q.push(v);',
    '            }',
    '        }',
    '    }',
    '}'
  ];

  const [queue, setQueue] = useState([]);
  const [visited, setVisited] = useState(new Set());
  const [steps, setSteps] = useState(0);
  const [speed, setSpeed] = useState(1000);
  const [playing, setPlaying] = useState(false);
  const [message, setMessage] = useState("Click Start!");
  const [activeNode, setActiveNode] = useState(null);
  const [activeLine, setActiveLine] = useState(-1);
  const timeoutRef = useRef(null);

  useEffect(() => {
    return () => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
    };
  }, []);

  const step = () => {
    setQueue(currentQueue => {
      if (currentQueue.length === 0) {
        setMessage("Traversal Complete ðŸŽ‰");
        setPlaying(false);
        return currentQueue;
      }

      const node = currentQueue[0];
      const newQueue = currentQueue.slice(1);

      setVisited(prev => new Set([...prev, node]));
      setSteps(s => s + 1);
      setMessage(`Visiting node ${node}`);
      setActiveNode(node);
      setActiveLine(5);

      const neighbors = graph[node].filter(n => !visited.has(n) && !newQueue.includes(n));
      const updatedQueue = [...newQueue, ...neighbors];

      timeoutRef.current = setTimeout(() => {
        setQueue(updatedQueue);
      }, speed);

      return updatedQueue;
    });
  };

  useEffect(() => {
    if (playing && queue.length > 0) {
      step();
    }
  }, [queue, playing]);

  const start = () => {
    reset();
    setPlaying(true);
    setQueue(["A"]);
  };

  const reset = () => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    setQueue([]);
    setVisited(new Set());
    setSteps(0);
    setPlaying(false);
    setMessage("Click Start!");
    setActiveNode(null);
    setActiveLine(-1);
  };

  return (
    <div className="bg-gray-900 min-h-screen text-white font-sans">
      {/* Top Banner Ad */}
      <div className="bg-gray-800 p-4 text-center border-b border-gray-700">
        <div className="w-[728px] h-[90px] bg-gray-700 mx-auto flex items-center justify-center text-gray-500 rounded">
          Ad Space (728x90)
        </div>
      </div>

      <div className="flex max-w-[1400px] mx-auto">
        {/* Left Sidebar Ad */}
        <div className="w-40 p-5">
          <div className="sticky top-5 bg-gray-700 w-40 h-[600px] flex items-center justify-center text-gray-500 rounded text-xs text-center">
            Ad Space<br />(160x600)
          </div>
        </div>

        {/* Main Content */}
        <div className="flex-1 p-10">
          <h1 className="text-center text-5xl mb-2">Graph BFS</h1>

          {/* Complexity Info */}
          <div className="flex justify-center gap-8 mb-8 text-lg">
            <div>Time: <span className="text-green-500 font-bold">O(V + E)</span></div>
            <div>Space: <span className="text-green-500 font-bold">O(V)</span></div>
            <div>Steps: <span className="text-yellow-500 font-bold">{steps}</span></div>
          </div>

          {/* Controls */}
          <div className="text-center mb-8">
            <label className="text-lg mr-2">Speed (ms):</label>
            <input
              type="number"
              value={speed}
              onChange={(e) => setSpeed(Number(e.target.value))}
              min="100"
              max="5000"
              step="100"
              className="w-24 p-2 text-lg bg-gray-700 text-white border-2 border-gray-600 rounded mr-5"
            />

            <button
              onClick={start}
              className="px-8 py-3 text-lg bg-green-500 text-white rounded cursor-pointer mr-2 hover:bg-green-600"
            >
              Start
            </button>

            <button
              onClick={reset}
              className="px-8 py-3 text-lg bg-red-500 text-white rounded cursor-pointer hover:bg-red-600"
            >
              Reset
            </button>
          </div>

          {/* Message */}
          <div className="text-center text-xl mb-8 p-4 bg-gray-700 rounded-lg min-h-[60px] flex items-center justify-center">
            {message}
          </div>

          {/* Graph Visualization */}
          <div className="flex justify-center gap-10 mb-10">
            {Object.keys(graph).map(node => {
              let bg = "bg-gray-600";
              if (visited.has(node)) bg = "bg-gray-800";
              if (node === activeNode) bg = "bg-yellow-500";

              return (
                <div key={node} className="text-center">
                  <div className={`w-20 h-20 rounded-full ${bg} flex items-center justify-center text-3xl font-bold`}>
                    {node}
                  </div>
                </div>
              );
            })}
          </div>

          {/* Code */}
          <div className="bg-gray-800 rounded-lg p-5 mb-10">
            <div className="text-gray-500 text-sm mb-2 font-bold">
              C++ CODE (Execution Flow):
            </div>
            <pre className="font-mono text-base m-0 leading-7">
              {codeLines.map((line, idx) => (
                <div
                  key={idx}
                  className={`p-1 px-2 ${activeLine === idx ? 'bg-yellow-900 border-l-4 border-yellow-500' : 'border-l-4 border-transparent'}`}
                >
                  {line}
                </div>
              ))}
            </pre>
          </div>

          {/* Middle Ad */}
          <div className="bg-gray-700 w-[336px] h-[280px] my-10 mx-auto flex items-center justify-center text-gray-500 rounded">
            Ad Space (336x280)
          </div>
        </div>

        {/* Right Sidebar Ad */}
        <div className="w-40 p-5">
          <div className="sticky top-5 bg-gray-700 w-40 h-[600px] flex items-center justify-center text-gray-500 rounded text-xs text-center">
            Ad Space<br />(160x600)
          </div>
        </div>
      </div>

      {/* Bottom Ad */}
      <div className="bg-gray-800 p-5 text-center border-t border-gray-700 mt-10">
        <div className="w-[728px] h-[90px] bg-gray-700 mx-auto flex items-center justify-center text-gray-500 rounded">
          Ad Space (728x90)
        </div>
      </div>
    </div>
  );
}
